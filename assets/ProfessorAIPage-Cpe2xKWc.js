import{l as ne,o as ie,q as ce,m as le,r as c,s as de,W as J,j as t,A as K,c as C,t as Q,a as ue}from"./index-Cf9C7PVC.js";import{C as me,a as fe}from"./ChatMessage-CICt4h1A.js";import{s as ge,a as pe}from"./geminiService-DJIPhCmJ.js";import{C as he}from"./Card-C8Vt2KLr.js";import{I as xe}from"./Input-gw2yEWz2.js";import{d as be}from"./downloadHelper-Y0t7dfPR.js";const N="sharon-professorAiMessages",Ie=()=>{var G,H,F;const{settings:l,updateSettings:U}=ne(),f=ie(),{addToast:n}=ce(),{openSaveToDriveModal:V}=le(),[O,R]=c.useState(null),[r,d]=c.useState([]),[y,k]=c.useState(!1),[T,h]=c.useState(null),[i,L]=c.useState(l.currentSubject||""),[g,W]=c.useState(null),[v,M]=c.useState(!1),[w,X]=c.useState(void 0),Y=c.useRef(null),_=c.useRef(!1),Z=()=>{var e;(e=Y.current)==null||e.scrollIntoView({behavior:"smooth"})};c.useEffect(Z,[r]),c.useEffect(()=>{var e;if((e=f.state)!=null&&e.initialText&&!v){W(f.state.initialText),f.state.documentName&&X(f.state.documentName);const s=f.state.documentName?` from "${f.state.documentName}"`:"";n(`Text loaded${s} for Professor AI. Please set a subject to begin.`,"info"),f.state.sourceFeatureName&&window.history.replaceState({},document.title)}},[f.state,v,n]),c.useEffect(()=>{const e=l.currentSubject;if(e&&!v&&!g){L(e);const s=localStorage.getItem(N);if(s)try{const a=JSON.parse(s);if(a.subject===e&&Array.isArray(a.messages)){d(a.messages.map(o=>({...o,timestamp:new Date(o.timestamp)})));const x=a.messages.map(o=>({role:o.sender==="user"?"user":"model",parts:[{text:o.text}]}));E(e,x),n(`Resumed Professor AI session for ${e}.`,"info");return}}catch(a){console.error("Failed to parse stored messages:",a),localStorage.removeItem(N)}e&&E(e)}},[l.currentSubject,g]),c.useEffect(()=>{if(v&&i)try{const e=JSON.stringify({subject:i,messages:r});localStorage.setItem(N,e)}catch(e){console.error("Failed to save Professor AI messages:",e),n("Could not save chat history.","warning")}},[r,i,v,n]);const $=async(e,s,a=!1,x=!1)=>{const o=s||O;if(!o){h("Professor AI session is not active. Please start a session."),n("Session not active. Please start.","warning");return}if(!x){const p={id:crypto.randomUUID(),sender:"user",text:e,timestamp:new Date};d(m=>[...m,p])}k(!0),h(null);let I="";const A=crypto.randomUUID();let z=[],b={sources:[]};(!a||a&&!x)&&d(p=>[...p,{id:A,sender:"ai",text:"...",timestamp:new Date,metadata:{suggestions:[],sources:[]}}]);try{await pe(o,e,(p,m,P,S)=>{if(P){h(P),d(j=>j.map(u=>u.id===A?{...u,text:`Error: ${P}`}:u)),k(!1);return}if(I=p,S&&S.length>0&&(b={sources:S}),m){const j="Next, you could ask:";if(I.includes(j)){const u=I.split(j);u[1]&&(z=u[1].split(`
`).map(D=>D.replace(/^[-*]?\s*/,"").trim()).filter(D=>D.length>0&&D.length<100))}}d(a&&x&&m?[{id:A,sender:"ai",text:I,timestamp:new Date,metadata:{sources:b==null?void 0:b.sources,suggestions:z}}]:j=>j.map(u=>u.id===A?{...u,text:I,metadata:{sources:b==null?void 0:b.sources,suggestions:z}}:u)),m&&k(!1)})}catch(p){console.error("Error during Professor AI stream:",p);const m=p.message||"An error occurred while sending the message.";h(m),d(P=>P.map(S=>S.id===A?{...S,text:`Error: ${m}`}:S)),k(!1),n(m,"error")}},E=c.useCallback(async(e,s)=>{k(!0),h(null),_.current=!1;let a=`You are "Professor AI," an expert academic mentor.
    Your current subject of expertise is: "${e||"General Academic Topics"}".
    The user is at the ${l.academicLevel||de.UNDERGRADUATE} level. Your feedback should be tailored accordingly.
    Your writing tone should be ${l.writingTone||J.ACADEMIC_CRITICAL}.

    Primary tasks:
    1.  Provide constructive, critical feedback on submitted academic text (essays, proposals, arguments, etc.).
    2.  Identify strengths and weaknesses in reasoning, structure, clarity, and academic rigor.
    3.  Suggest specific, actionable revisions to enhance the quality of the work.
    4.  Explain complex concepts within "${e}" clearly.
    5.  Reference appropriate academic standards and conventions.`;l.geographicRegion==="Nigeria"&&(a+=`
    - The student is likely from a Nigerian university context. When providing examples or discussing academic norms, consider this context where relevant (e.g., project structures, common student challenges). Use examples relevant to Nigeria if natural.`,l.department&&(a+=` The student's department is ${l.department}.`)),a+=`
    Interaction style:
    - Be thorough and analytical.
    - If reviewing text, structure your feedback clearly (e.g., "Overall Impression," "Strengths," "Areas for Improvement," "Specific Suggestions").
    - Where appropriate, end your responses by suggesting 1-2 brief follow-up questions or discussion points the user might consider to deepen their understanding or refine their work further. Start these suggestions with a clear marker, like "Next, you could ask:".
    ${!s||s.length===0?"Start by warmly greeting the user and confirming the subject you are ready to provide feedback on. Ask how you can assist.":""}`;const x={...l,writingTone:l.writingTone||J.ACADEMIC_CRITICAL,currentSubject:e,systemInstruction:a};try{const o=ge(x,s);R(o),M(!0),(!s||s.length===0)&&await $("Hello Professor AI!",o,!0,!0),g&&o&&!_.current?setTimeout(async()=>{await $(`Please provide feedback on the following text related to ${e}:

"""
${g}
"""`,o,!0,!1),_.current=!0,W(null)},100):g||n(`Professor AI session for ${e} started/resumed.`,"success")}catch(o){console.error("Failed to initialize Professor AI chat:",o),h(o.message||"Could not start Professor AI chat. Check API Key/network."),R(null),M(!1)}finally{k(!1)}},[l,g,n]),ee=()=>{if(!i.trim()){n("Subject is required to start the session.","warning");return}U({currentSubject:i}),d([]),localStorage.removeItem(N),E(i)},te=()=>{d([]),localStorage.removeItem(N),n("Chat history cleared.","info"),O&&i&&E(i)},q=e=>e.map(s=>`[${s.sender.toUpperCase()}] (${s.timestamp.toLocaleString()}):
${s.text}
`).join(`
---
`),B=(e,s)=>{const a=e.replace(/[^\w\s-]/gi,"").replace(/\s+/g,"_")||"ProfessorAI_Session";return`${ue} - ProfessorAI - ${a}_Transcript.${s}`},se=()=>{if(r.length===0){n("No messages to download.","info");return}const e=q(r),s=B(w||i,"txt");be(e,s),n("Transcript download initiated.","success")},re=()=>{if(r.length===0){n("No transcript to save.","info");return}const e=q(r),s=B(w||i,"txt");V(e,s)},ae=()=>{R(null),d([]),L(""),h(null),M(!1),U({currentSubject:""}),n("Professor AI session ended.","info")},oe=e=>{$(e)};return v?t.jsxs("div",{className:"flex flex-col h-[calc(100vh-8rem)] md:h-[calc(100vh-10rem)] max-h-[calc(100vh-10rem)] bg-card dark:bg-dark-card rounded-lg shadow-xl",children:[t.jsxs("header",{className:"p-4 border-b border-border dark:border-dark-border flex justify-between items-center",children:[t.jsxs("h1",{className:"text-xl font-semibold text-foreground dark:text-dark-foreground flex items-center",children:[t.jsx(K,{className:"h-6 w-6 mr-2 text-primary dark:text-dark-primary"}),"Professor AI: ",i]}),t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsx(C,{onClick:se,variant:"outline",size:"sm",disabled:r.length===0,children:"Download Transcript"}),t.jsx(C,{onClick:re,variant:"outline",size:"sm",disabled:r.length===0,children:"Save to Google Drive"}),t.jsx(C,{onClick:te,variant:"outline",size:"sm",disabled:r.length<=1&&((G=r[0])==null?void 0:G.sender)==="ai",children:"Clear History"}),t.jsx(C,{onClick:ae,variant:"outline",size:"sm",children:"End Session"})]})]}),t.jsxs("div",{className:"flex-1 p-4 overflow-y-auto space-y-2 bg-muted/30 dark:bg-dark-background","aria-live":"polite","aria-busy":y,children:[r.map(e=>t.jsx(me,{message:e,onSuggestionClick:oe},e.id)),t.jsx("div",{ref:Y}),y&&r.length>0&&((H=r[r.length-1])==null?void 0:H.sender)==="ai"&&((F=r[r.length-1])==null?void 0:F.text)==="..."&&t.jsx("div",{className:"flex justify-start py-2 pl-12",children:t.jsx(Q,{text:"Professor AI is reviewing...",size:"sm"})})]}),T&&!y&&t.jsx("p",{className:"p-2 text-sm text-center text-destructive bg-destructive/10",children:T}),t.jsx(fe,{onSendMessage:e=>$(e),isLoading:y,placeholder:`Ask Professor AI about ${i}...`})]}):t.jsxs("div",{className:"space-y-6 p-4 md:p-6",children:[t.jsxs("header",{className:"pb-4",children:[t.jsxs("h1",{className:"text-3xl font-bold tracking-tight text-foreground dark:text-dark-foreground flex items-center",children:[t.jsx(K,{className:"h-8 w-8 mr-2 text-primary dark:text-dark-primary"}),"Professor AI"]}),t.jsx("p",{className:"mt-1 text-muted-foreground dark:text-dark-muted-foreground",children:"Get expert feedback on your academic work."})]}),t.jsxs(he,{title:"Start Your Feedback Session",children:[g&&w&&t.jsxs("p",{className:"mb-3 text-sm text-primary dark:text-dark-primary bg-primary/10 dark:bg-dark-primary/20 p-2 rounded-md",children:['Loaded text from "',w,'". Please confirm or set a subject below to proceed with feedback.']}),g&&!w&&t.jsx("p",{className:"mb-3 text-sm text-primary dark:text-dark-primary bg-primary/10 dark:bg-dark-primary/20 p-2 rounded-md",children:"Loaded text from another tool. Please confirm or set a subject below to proceed with feedback."}),t.jsx("p",{className:"mb-4 text-sm text-muted-foreground dark:text-dark-muted-foreground",children:"What subject is your work related to? This helps Professor AI provide targeted feedback."}),t.jsx(xe,{label:"Subject of Work",placeholder:"e.g., Sociology, Quantum Physics, Renaissance Literature",value:i,onChange:e=>L(e.target.value),containerClassName:"mb-4","aria-required":"true"}),T&&t.jsx("p",{className:"text-sm text-destructive mb-3",children:T}),t.jsx(C,{onClick:ee,disabled:!i.trim()||y,children:y?t.jsx(Q,{size:"sm"}):`Start Session on ${i||"..."}`})]})]})};export{Ie as default};
