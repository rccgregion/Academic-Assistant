import{l as F,m as J,r as c,q as V,s as X,W as Q,j as t,h as U,c as b,t as q,a as Z}from"./index-DwfKsHWR.js";import{C as ee,a as te}from"./ChatMessage-BbaAccpr.js";import{s as se,a as re}from"./geminiService-BkXzVexN.js";import{C as ae}from"./Card-BP-gc27O.js";import{I as ne}from"./Input-CaI1NqfY.js";import{d as oe}from"./downloadHelper-Y0t7dfPR.js";const j="sharon-studyBuddyMessages",ge=()=>{var z,P,R;const{settings:i,updateSettings:B}=F(),{openSaveToDriveModal:L}=J(),[I,A]=c.useState(null),[r,l]=c.useState([]),[h,f]=c.useState(!1),[k,g]=c.useState(null),[n,E]=c.useState(i.currentSubject||""),[w,S]=c.useState(!1),{addToast:o}=V(),$=c.useRef(null),O=()=>{var e;(e=$.current)==null||e.scrollIntoView({behavior:"smooth"})};c.useEffect(O,[r]),c.useEffect(()=>{if(i.currentSubject&&!w){E(i.currentSubject);const e=localStorage.getItem(j);if(e)try{const s=JSON.parse(e);if(s.subject===i.currentSubject&&Array.isArray(s.messages)){l(s.messages.map(a=>({...a,timestamp:new Date(a.timestamp)}))),C(i.currentSubject,s.messages.map(a=>({role:a.sender==="user"?"user":"model",parts:[{text:a.text}]}))),S(!0),o(`Resumed study session for ${i.currentSubject}.`,"info");return}}catch(s){console.error("Failed to parse stored messages:",s),localStorage.removeItem(j)}i.currentSubject&&(C(i.currentSubject),S(!0))}},[i.currentSubject]),c.useEffect(()=>{if(w&&n)try{const e=JSON.stringify({subject:n,messages:r});localStorage.setItem(j,e)}catch(e){console.error("Failed to save messages to localStorage:",e),o("Could not save chat history.","warning")}},[r,n,w,o]);const C=c.useCallback((e,s)=>{f(!0),g(null);let a=`You are "Study Buddy AI," a friendly, patient, and encouraging AI tutor.
    Your current subject of focus is: "${e}".
    The user is at the ${i.academicLevel||X.UNDERGRADUATE} level. Assume they have some foundational knowledge but might need clarification on specifics.
    Your primary goals are to:
    1.  Explain concepts clearly and concisely related to "${e}".
    2.  Help the user practice by asking relevant questions or creating mini-quizzes on the topic.
    3.  Assist with problem-solving by guiding them through steps rather than giving direct answers immediately.
    4.  Engage in discussions about "${e}" to deepen understanding.
    5.  Offer encouragement and effective study tips.

    Interaction style:
    - Be interactive. Ask follow-up questions to check understanding.
    - Use examples to illustrate points.`;i.geographicRegion==="Nigeria"&&(a+=`
    - When explaining concepts or providing examples, try to use contexts relevant to Nigeria (e.g., Nigerian history, culture, common student experiences) where appropriate and natural.`),a+=`
    - If asked a question outside of "${e}", politely steer the conversation back or state you're focused on the current subject.
    - Keep your tone supportive and positive. Avoid overly complex jargon unless explaining it.
    - Where appropriate, end your responses by suggesting 1-2 brief follow-up questions or discussion points the user might consider to deepen their understanding or practice further. Start these suggestions with a clear marker, like "Next, you could ask:".
    - Start by warmly greeting the user and confirming the subject you're ready to discuss.`;const y={...i,writingTone:Q.EXPLANATORY,currentSubject:e,systemInstruction:a};try{const p=se(y,s);if(A(p),!s||s.length===0){const d={id:crypto.randomUUID(),sender:"ai",text:`Hi there! I'm your Study Buddy, ready to help you with ${e}! What specific topic within ${e} shall we dive into first? Or, ask me anything to get started!`,timestamp:new Date};l([d])}S(!0),o(`Study session for ${e} started!`,"success")}catch(p){console.error("Failed to initialize Study Buddy chat:",p);const d=p.message||"Could not start Study Buddy. Check API Key/network.";g(d),o(d,"error"),A(null),S(!1)}finally{f(!1)}},[i,o]),W=()=>{if(!n.trim()){o("Subject is required to start a study session.","warning");return}B({currentSubject:n}),l([]),localStorage.removeItem(j),C(n)},Y=()=>{const e=r.find(s=>s.sender==="ai");l(e?[e]:[]),localStorage.removeItem(j),o("Chat history cleared.","info"),I&&n&&C(n)},D=e=>e.map(s=>`[${s.sender.toUpperCase()}] (${s.timestamp.toLocaleString()}):
${s.text}
`).join(`
---
`),M=(e,s)=>{const a=e.replace(/[^\w\s-]/gi,"").replace(/\s+/g,"_")||"StudySession";return`${Z} - StudyBuddy - ${a}_Transcript.${s}`},H=()=>{if(r.length===0){o("No messages to download.","info");return}const e=D(r),s=M(n,"txt");oe(e,s),o("Transcript download initiated.","success")},_=()=>{if(r.length===0){o("No transcript to save.","info");return}const e=D(r),s=M(n,"txt");L(e,s)},G=()=>{A(null),E(""),g(null),S(!1),B({currentSubject:""}),o("Study session ended.","info")},K=e=>{T(e)},T=async e=>{if(!I){g("Study session is not active. Please start a session."),o("Session not active. Please start.","warning");return}const s={id:crypto.randomUUID(),sender:"user",text:e,timestamp:new Date};l(d=>[...d,s]),f(!0),g(null);let a="";const y=crypto.randomUUID();let p=[];l(d=>[...d,{id:y,sender:"ai",text:"...",timestamp:new Date,metadata:{suggestions:[]}}]);try{await re(I,e,(d,x,v)=>{if(v){g(v),l(u=>u.map(m=>m.id===y?{...m,text:`Error: ${v}`}:m)),f(!1);return}if(a=d,x){const u="Next, you could ask:";if(a.includes(u)){const m=a.split(u);m[1]&&(p=m[1].split(`
`).map(N=>N.replace(/^[-*]?\s*/,"").trim()).filter(N=>N.length>0&&N.length<100))}}l(u=>u.map(m=>m.id===y?{...m,text:a,metadata:{suggestions:p}}:m)),x&&f(!1)})}catch(d){console.error("Error during Study Buddy stream:",d);const x=d.message||"An error occurred while sending the message.";g(x),l(v=>v.map(u=>u.id===y?{...u,text:`Error: ${x}`}:u)),f(!1),o(x,"error")}};return w?t.jsxs("div",{className:"flex flex-col h-[calc(100vh-8rem)] md:h-[calc(100vh-10rem)] max-h-[calc(100vh-10rem)] bg-card dark:bg-dark-card rounded-lg shadow-xl",children:[t.jsxs("header",{className:"p-4 border-b border-border dark:border-dark-border flex justify-between items-center",children:[t.jsxs("h1",{className:"text-xl font-semibold text-foreground dark:text-dark-foreground flex items-center",children:[t.jsx(U,{className:"h-6 w-6 mr-2 text-primary dark:text-dark-primary"}),"Study Buddy: ",n]}),t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsx(b,{onClick:H,variant:"outline",size:"sm",disabled:r.length===0,children:"Download Transcript"}),t.jsx(b,{onClick:_,variant:"outline",size:"sm",disabled:r.length===0,children:"Save to Google Drive"}),t.jsx(b,{onClick:Y,variant:"outline",size:"sm",disabled:r.length<=1&&((z=r[0])==null?void 0:z.sender)==="ai",children:"Clear History"}),t.jsx(b,{onClick:G,variant:"outline",size:"sm",children:"End Session"})]})]}),t.jsxs("div",{className:"flex-1 p-4 overflow-y-auto space-y-2 bg-muted/30 dark:bg-dark-background","aria-live":"polite","aria-busy":h,children:[r.map(e=>t.jsx(ee,{message:e,onSuggestionClick:K},e.id)),t.jsx("div",{ref:$}),h&&r.length>0&&((P=r[r.length-1])==null?void 0:P.sender)==="ai"&&((R=r[r.length-1])==null?void 0:R.text)==="..."&&t.jsx("div",{className:"flex justify-start py-2 pl-12",children:t.jsx(q,{text:"Study Buddy is thinking...",size:"sm"})})]}),k&&!h&&t.jsx("p",{className:"p-2 text-sm text-center text-destructive bg-destructive/10",children:k}),t.jsx(te,{onSendMessage:T,isLoading:h,placeholder:`Ask about ${n}...`})]}):t.jsxs("div",{className:"space-y-6 p-4 md:p-6",children:[t.jsxs("header",{className:"pb-4",children:[t.jsxs("h1",{className:"text-3xl font-bold tracking-tight text-foreground dark:text-dark-foreground flex items-center",children:[t.jsx(U,{className:"h-8 w-8 mr-2 text-primary dark:text-dark-primary"}),"Study Buddy AI"]}),t.jsx("p",{className:"mt-1 text-muted-foreground dark:text-dark-muted-foreground",children:"Your personal AI tutor for any subject."})]}),t.jsxs(ae,{title:"Start Your Study Session",children:[t.jsx("p",{className:"mb-4 text-sm text-muted-foreground dark:text-dark-muted-foreground",children:"Tell Study Buddy what subject you'd like to focus on today."}),t.jsx(ne,{label:"Subject of Study",placeholder:"e.g., Organic Chemistry, World War II History, Python Programming",value:n,onChange:e=>E(e.target.value),containerClassName:"mb-4","aria-required":"true"}),k&&t.jsx("p",{className:"text-sm text-destructive mb-3",children:k}),t.jsx(b,{onClick:W,disabled:!n.trim()||h,children:h?t.jsx(q,{size:"sm"}):`Start Studying ${n||"..."}`})]})]})};export{ge as default};
