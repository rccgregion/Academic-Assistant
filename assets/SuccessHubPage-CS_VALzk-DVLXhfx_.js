import{f as B,y as F,m as J,v as c,u as s,U as Y,a as $,l as G,d as V}from"./index-CL7HjhdV.js";import{b as W}from"./Card-C8Vt2KLr-CXW7Tvcj.js";import{C as K,M as Q}from"./ChatMessage-CICt4h1A-CShhxGyx.js";import{u as X,f as Z}from"./geminiService-DJIPhCmJ-Bm2owfCC.js";import{c as ee}from"./downloadHelper-Y0t7dfPR--lPmL3re.js";const j="sharon-successHubMessages",oe=()=>{var H,D;const{settings:w}=B(),{addToast:o}=F(),{openSaveToDriveModal:M}=J(),[I,O]=c.useState(null),[r,u]=c.useState([]),[x,g]=c.useState(!1),[U,p]=c.useState(null),A=c.useRef(null),R=()=>{var e;(e=A.current)==null||e.scrollIntoView({behavior:"smooth"})};c.useEffect(R,[r]),c.useEffect(()=>{const e=localStorage.getItem(j);let t;if(e)try{const i=JSON.parse(e);u(i.map(a=>({...a,timestamp:new Date(a.timestamp)}))),t=i.map(a=>({role:a.sender==="user"?"user":"model",parts:[{text:a.text}]})),o("Resumed previous Success Hub session.","info")}catch(i){console.error("Failed to parse stored Success Hub messages:",i),localStorage.removeItem(j)}T(t)},[]),c.useEffect(()=>{if(r.length>0)try{localStorage.setItem(j,JSON.stringify(r))}catch(e){console.error("Failed to save Success Hub messages:",e),o("Could not save chat history.","warning")}},[r,o]);const T=c.useCallback(async e=>{g(!0),p(null);const t=`You are an AI academic success assistant for SHARON. 
    Users will ask questions about academic writing, research practices, university guidelines (especially Nigerian university contexts if mentioned), study skills, and thesis/dissertation development. 
    Provide helpful, concise, and actionable advice. Use web grounding to find relevant and up-to-date information where appropriate. 
    Tailor responses to a ${w.academicLevel} student using a ${w.writingTone} tone.
    Be interactive. Where appropriate, you can end your response by suggesting 1-2 brief follow-up questions or discussion points the user might consider. Clearly mark these suggestions, for example, by starting them with "Next, you could ask:".
    ${!e||e.length===0?"Start by warmly greeting the user and asking how you can assist them with their academic success today.":""}`,i={...w,systemInstruction:t,useGrounding:!0};try{const a=X(i,e);O(a),(!e||e.length===0)&&await N("Hello!",a,!0,!0)}catch(a){p(a.message||"Could not start chat."),o(a.message||"Could not start chat.","error")}finally{g(!1)}},[w,o]),N=async(e,t,i=!1,a=!1)=>{const v=t||I;if(!v){p("Chat not initialized."),o("Chat not initialized. Please refresh.","error");return}if(!a){const m={id:crypto.randomUUID(),sender:"user",text:e,timestamp:new Date};u(l=>[...l,m])}g(!0),p(null);const d=crypto.randomUUID();let y="",b={sources:[]},C=[];(!i||i&&!a)&&u(m=>[...m,{id:d,sender:"ai",text:"...",timestamp:new Date,metadata:{sources:[],suggestions:[]}}]);try{await Z(v,e,(m,l,k,h)=>{if(k){p(k),u(f=>f.map(n=>n.id===d?{...n,text:`Error: ${k}`}:n)),g(!1);return}if(y=m,h&&h.length>0&&(b={sources:h}),l){const f="Next, you could ask:";if(y.includes(f)){const n=y.split(f);n[1]&&(C=n[1].split(`
`).map(S=>S.replace(/^[-*]?\s*/,"").trim()).filter(S=>S.length>0&&S.length<100))}}u(i&&a&&l?[{id:d,sender:"ai",text:y,timestamp:new Date,metadata:{sources:b==null?void 0:b.sources,suggestions:C}}]:f=>f.map(n=>n.id===d?{...n,text:y,metadata:{sources:b==null?void 0:b.sources,suggestions:C}}:n)),l&&g(!1)})}catch(m){const l=m.message||"Error sending message.";p(l),u(k=>k.map(h=>h.id===d?{...h,text:`Error: ${l}`}:h)),g(!1),o(l,"error")}},L=()=>{u([]),localStorage.removeItem(j),o("Chat history cleared.","info"),I&&T()},z=e=>e.map(t=>{var i,a;return`[${t.sender.toUpperCase()}] (${t.timestamp.toLocaleString()}):
${t.text}${(a=(i=t.metadata)==null?void 0:i.sources)!=null&&a.length?`
Sources:
`+t.metadata.sources.map(v=>{var d;return(d=v.web||v.retrievedContext)==null?void 0:d.uri}).join(`
`):""}
`}).join(`
---
`),E=(e,t)=>{const i=e.replace(/[^\w\s-]/gi,"").replace(/\s+/g,"_")||"SuccessHub_Chat";return`${V} - ${i}_Transcript.${t}`},_=()=>{if(r.length===0){o("No messages to download.","info");return}const e=z(r),t=E("SuccessHub","txt");ee(e,t),o("Transcript download initiated.","success")},q=()=>{if(r.length===0){o("No transcript to save.","info");return}const e=z(r),t=E("SuccessHub","txt");M(e,t)},P=e=>{N(e)};return s.jsxs("div",{className:"space-y-6",children:[s.jsxs("header",{className:"pb-4",children:[s.jsxs("h1",{className:"text-2xl md:text-3xl font-bold tracking-tight text-foreground dark:text-dark-foreground flex items-center",children:[s.jsx(Y,{className:"h-8 w-8 md:h-9 md:w-9 mr-3 text-primary dark:text-dark-primary"}),"Academic Success Hub"]}),s.jsx("p",{className:"mt-1 text-muted-foreground dark:text-dark-muted-foreground",children:"Ask questions about academic writing, research, study skills, and more."})]}),s.jsxs(W,{className:"flex flex-col h-[calc(100vh-16rem)] md:h-[calc(100vh-18rem)] max-h-[calc(100vh-18rem)]",children:[s.jsxs("div",{className:"p-4 border-b border-border dark:border-dark-border flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Chat with SHARON Success AI"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx($,{onClick:_,variant:"outline",size:"sm",disabled:r.length===0,children:"Download"}),s.jsx($,{onClick:q,variant:"outline",size:"sm",disabled:r.length===0,children:"Save to Drive"}),s.jsx($,{onClick:L,variant:"outline",size:"sm",disabled:r.length===0&&!x,children:"Clear"})]})]}),s.jsxs("div",{className:"flex-1 p-4 overflow-y-auto space-y-2 bg-muted/30 dark:bg-dark-background","aria-live":"polite","aria-busy":x,children:[r.map(e=>s.jsx(K,{message:e,onSuggestionClick:P},e.id)),s.jsx("div",{ref:A}),x&&r.length>0&&((H=r[r.length-1])==null?void 0:H.sender)==="ai"&&((D=r[r.length-1])==null?void 0:D.text)==="..."&&s.jsx("div",{className:"flex justify-start py-2 pl-12",children:s.jsx(G,{text:"Thinking...",size:"sm"})})]}),U&&!x&&s.jsx("p",{className:"p-2 text-sm text-center text-destructive bg-destructive/10",children:U}),s.jsx(Q,{onSendMessage:N,isLoading:x,placeholder:"Ask about academic success..."})]})]})};export{oe as default};
