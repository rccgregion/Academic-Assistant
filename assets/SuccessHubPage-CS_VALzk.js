import{l as q,q as J,m as Y,r as l,j as s,y as F,c as I,t as G,a as K}from"./index-Cf9C7PVC.js";import{C as V}from"./Card-C8Vt2KLr.js";import{C as W,a as Q}from"./ChatMessage-CICt4h1A.js";import{s as X,a as Z}from"./geminiService-DJIPhCmJ.js";import{d as ee}from"./downloadHelper-Y0t7dfPR.js";const k="sharon-successHubMessages",oe=()=>{var A,U;const{settings:C}=q(),{addToast:o}=J(),{openSaveToDriveModal:R}=Y(),[T,_]=l.useState(null),[r,d]=l.useState([]),[v,p]=l.useState(!1),[E,f]=l.useState(null),H=l.useRef(null),z=()=>{var e;(e=H.current)==null||e.scrollIntoView({behavior:"smooth"})};l.useEffect(z,[r]),l.useEffect(()=>{const e=localStorage.getItem(k);let t;if(e)try{const n=JSON.parse(e);d(n.map(a=>({...a,timestamp:new Date(a.timestamp)}))),t=n.map(a=>({role:a.sender==="user"?"user":"model",parts:[{text:a.text}]})),o("Resumed previous Success Hub session.","info")}catch(n){console.error("Failed to parse stored Success Hub messages:",n),localStorage.removeItem(k)}D(t)},[]),l.useEffect(()=>{if(r.length>0)try{localStorage.setItem(k,JSON.stringify(r))}catch(e){console.error("Failed to save Success Hub messages:",e),o("Could not save chat history.","warning")}},[r,o]);const D=l.useCallback(async e=>{p(!0),f(null);const t=`You are an AI academic success assistant for SHARON. 
    Users will ask questions about academic writing, research practices, university guidelines (especially Nigerian university contexts if mentioned), study skills, and thesis/dissertation development. 
    Provide helpful, concise, and actionable advice. Use web grounding to find relevant and up-to-date information where appropriate. 
    Tailor responses to a ${C.academicLevel} student using a ${C.writingTone} tone.
    Be interactive. Where appropriate, you can end your response by suggesting 1-2 brief follow-up questions or discussion points the user might consider. Clearly mark these suggestions, for example, by starting them with "Next, you could ask:".
    ${!e||e.length===0?"Start by warmly greeting the user and asking how you can assist them with their academic success today.":""}`,n={...C,systemInstruction:t,useGrounding:!0};try{const a=X(n,e);_(a),(!e||e.length===0)&&await j("Hello!",a,!0,!0)}catch(a){f(a.message||"Could not start chat."),o(a.message||"Could not start chat.","error")}finally{p(!1)}},[C,o]),j=async(e,t,n=!1,a=!1)=>{const b=t||T;if(!b){f("Chat not initialized."),o("Chat not initialized. Please refresh.","error");return}if(!a){const h={id:crypto.randomUUID(),sender:"user",text:e,timestamp:new Date};d(c=>[...c,h])}p(!0),f(null);const u=crypto.randomUUID();let y="",m={sources:[]},N=[];(!n||n&&!a)&&d(h=>[...h,{id:u,sender:"ai",text:"...",timestamp:new Date,metadata:{sources:[],suggestions:[]}}]);try{await Z(b,e,(h,c,S,g)=>{if(S){f(S),d(x=>x.map(i=>i.id===u?{...i,text:`Error: ${S}`}:i)),p(!1);return}if(y=h,g&&g.length>0&&(m={sources:g}),c){const x="Next, you could ask:";if(y.includes(x)){const i=y.split(x);i[1]&&(N=i[1].split(`
`).map(w=>w.replace(/^[-*]?\s*/,"").trim()).filter(w=>w.length>0&&w.length<100))}}d(n&&a&&c?[{id:u,sender:"ai",text:y,timestamp:new Date,metadata:{sources:m==null?void 0:m.sources,suggestions:N}}]:x=>x.map(i=>i.id===u?{...i,text:y,metadata:{sources:m==null?void 0:m.sources,suggestions:N}}:i)),c&&p(!1)})}catch(h){const c=h.message||"Error sending message.";f(c),d(S=>S.map(g=>g.id===u?{...g,text:`Error: ${c}`}:g)),p(!1),o(c,"error")}},O=()=>{d([]),localStorage.removeItem(k),o("Chat history cleared.","info"),T&&D()},$=e=>e.map(t=>{var n,a;return`[${t.sender.toUpperCase()}] (${t.timestamp.toLocaleString()}):
${t.text}${(a=(n=t.metadata)==null?void 0:n.sources)!=null&&a.length?`
Sources:
`+t.metadata.sources.map(b=>{var u;return(u=b.web||b.retrievedContext)==null?void 0:u.uri}).join(`
`):""}
`}).join(`
---
`),M=(e,t)=>{const n=e.replace(/[^\w\s-]/gi,"").replace(/\s+/g,"_")||"SuccessHub_Chat";return`${K} - ${n}_Transcript.${t}`},L=()=>{if(r.length===0){o("No messages to download.","info");return}const e=$(r),t=M("SuccessHub","txt");ee(e,t),o("Transcript download initiated.","success")},P=()=>{if(r.length===0){o("No transcript to save.","info");return}const e=$(r),t=M("SuccessHub","txt");R(e,t)},B=e=>{j(e)};return s.jsxs("div",{className:"space-y-6",children:[s.jsxs("header",{className:"pb-4",children:[s.jsxs("h1",{className:"text-2xl md:text-3xl font-bold tracking-tight text-foreground dark:text-dark-foreground flex items-center",children:[s.jsx(F,{className:"h-8 w-8 md:h-9 md:w-9 mr-3 text-primary dark:text-dark-primary"}),"Academic Success Hub"]}),s.jsx("p",{className:"mt-1 text-muted-foreground dark:text-dark-muted-foreground",children:"Ask questions about academic writing, research, study skills, and more."})]}),s.jsxs(V,{className:"flex flex-col h-[calc(100vh-16rem)] md:h-[calc(100vh-18rem)] max-h-[calc(100vh-18rem)]",children:[s.jsxs("div",{className:"p-4 border-b border-border dark:border-dark-border flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Chat with SHARON Success AI"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(I,{onClick:L,variant:"outline",size:"sm",disabled:r.length===0,children:"Download"}),s.jsx(I,{onClick:P,variant:"outline",size:"sm",disabled:r.length===0,children:"Save to Drive"}),s.jsx(I,{onClick:O,variant:"outline",size:"sm",disabled:r.length===0&&!v,children:"Clear"})]})]}),s.jsxs("div",{className:"flex-1 p-4 overflow-y-auto space-y-2 bg-muted/30 dark:bg-dark-background","aria-live":"polite","aria-busy":v,children:[r.map(e=>s.jsx(W,{message:e,onSuggestionClick:B},e.id)),s.jsx("div",{ref:H}),v&&r.length>0&&((A=r[r.length-1])==null?void 0:A.sender)==="ai"&&((U=r[r.length-1])==null?void 0:U.text)==="..."&&s.jsx("div",{className:"flex justify-start py-2 pl-12",children:s.jsx(G,{text:"Thinking...",size:"sm"})})]}),E&&!v&&s.jsx("p",{className:"p-2 text-sm text-center text-destructive bg-destructive/10",children:E}),s.jsx(Q,{onSendMessage:j,isLoading:v,placeholder:"Ask about academic success..."})]})]})};export{oe as default};
